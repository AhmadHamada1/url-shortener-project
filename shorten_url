import json
import uuid
import boto3

# AWS clients
s3 = boto3.client('s3', region_name='me-south-1')
dynamodb = boto3.resource('dynamodb', region_name='me-south-1')

# Constants
BUCKET_NAME = 'buraq-shorten-url'
TABLE_NAME = 'UrlShortener'

def lambda_handler(event, context):
    try:
        # Parse incoming JSON body
        body = json.loads(event['body'])
        long_url = body['url']

        # Validate URL
        if not long_url.startswith("http"):
            raise ValueError("URL must start with http or https")

        # Generate short ID
        short_id = str(uuid.uuid4())[:6]

        # Create redirect HTML
        redirect_html = f"""
        <!DOCTYPE html>
        <html>
          <head>
            <meta http-equiv="refresh" content="0; url={long_url}" />
          </head>
        </html>
        """

        # Upload redirect file to S3
        s3.put_object(
            Bucket=BUCKET_NAME,
            Key=short_id,
            Body=redirect_html,
            ContentType='text/html',
            ACL='public-read'  # Make it accessible via CloudFront
        )

        # Save to DynamoDB
        table = dynamodb.Table(TABLE_NAME)
        table.put_item(Item={
            'short_id': short_id,
            'long_url': long_url
        })

        # Return shortened URLs
        return {
            'statusCode': 200,
            'body': json.dumps({
                'short_url': f'https://sh.buraq.ai/{short_id}',
                'click_url': f'https://click.buraq.ai/{short_id}',
                'debug_url': f'http://{BUCKET_NAME}.s3-website.me-south-1.amazonaws.com/{short_id}'
            })
        }

    except Exception as e:
        return {
            'statusCode': 500,
            'body': json.dumps({'error': str(e)})
        }
